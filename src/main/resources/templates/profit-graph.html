<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ä»Šæ—¥ã®åˆ©ç›Š - Profit Graph</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap: 14px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN", Meiryo, sans-serif; margin: 24px auto; max-width: 1100px; padding: 0 16px; }
    header { display: flex; gap: var(--gap); align-items: center; justify-content: space-between; flex-wrap: wrap; }
    h1 { margin: 0 0 6px 0; font-size: 20px; }
    .muted { color: #666; font-size: 12px; }
    a.button, button { display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border:1px solid #222; border-radius:10px; background:#fff; color:#222; text-decoration:none; cursor:pointer; }
    a.button:hover, button:hover { background:#f7f7f7; }
    .kpi { display: grid; grid-template-columns: repeat(2, minmax(180px, 1fr)); gap: var(--gap); margin: 16px 0; }
    .card { border:1px solid #eee; border-radius:14px; padding:12px 14px; background:#fff; }
    .card h3 { margin:0 0 4px 0; font-size:14px; color:#444; }
    .value { font-variant-numeric: tabular-nums; font-size: 24px; }
    #chartWrap { border:1px solid #eee; border-radius:16px; padding:12px; }
    /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½KPIï¼ˆç´„å®šä»¶æ•°ï¼‰ */
    .linkcard { text-decoration: none; color: inherit; display:block; }
    .linkcard:hover { background:#fafafa; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="/css/simple.css"/>
</head>
<body>
  <header>
    <div>
      <h1>ä»Šæ—¥ã®åˆ©ç›Š</h1>
      <div class="muted">2ç§’ã”ã¨ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã—ã¦æç”»ã—ã¾ã™</div>
    </div>
    <div  style="display:flex; gap:8px; flex-wrap:wrap">
      <a class="button" href="/ui/main">â† æˆ»ã‚‹</a>
      <button id="btnPause">â¸ ä¸€æ™‚åœæ­¢</button>
      <button id="btnClear">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
    </div>
  </header>

  <!-- KPIï¼ˆè¨ºæ–­ãƒ‘ãƒãƒ«ã¯å‰Šé™¤ï¼‰ -->
  <section class="kpi">
    <div class="card">
      <h3>ä»Šæ—¥ã®åˆ©ç›Š</h3>
      <div id="todayProfitValue" class="value">-</div>
    </div>
    <!-- ç´„å®šä»¶æ•°ã¯ã‚¯ãƒªãƒƒã‚¯ã§ /ui/trades ã¸ -->
    <a class="card linkcard" href="/ui/trades" title="å–å¼•å±¥æ­´ã‚’è¡¨ç¤º">
      <h3>æœ¬æ—¥ã®ç´„å®šä»¶æ•°ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±¥æ­´ã¸ï¼‰</h3>
      <div id="tradesTodayValue" class="value">-</div>
    </a>
  </section>

  <!-- ã‚°ãƒ©ãƒ•ã ã‘ -->
  <section id="chartWrap">
    <canvas id="profitChart" height="200"></canvas>
  </section>

  <script>
    // ====== è¨­å®š ======
    const TRY_ENDPOINTS = ['/api/metrics?period=today', '/api/metrics', '/api/dev/metrics'];
    const POLL_MS = 2000, MAX_POINTS = 600;

    // ====== è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
    const fmtYen = new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' });
    const fmtNum = new Intl.NumberFormat('ja-JP', { maximumFractionDigits: 0 });
    const pick = (obj, keys, defVal = 0) => { for (const k of keys) if (obj && obj[k] != null) return obj[k]; return defVal; };
    const hhmmss = (d=new Date()) => String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0');

    // ====== ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ­£è¦åŒ–ï¼ˆtodayProfit / tradesToday ã‚’å¿…ãšå¾—ã‚‹ï¼‰ ======
    function normalizeMetrics(raw){
      let todayProfit = Number(pick(raw, ['todayProfit','todayprofit','profitToday','pnlToday','pnl'], 0));
      let tradesToday  = Number(pick(raw, ['tradesToday','trades','todayTrades','count'], 0));
      // Analyticså½¢å¼ï¼ˆcumulativePnLæœ«å°¾ï¼‰ã«ã‚‚å¯¾å¿œ
      if ((isNaN(todayProfit) || todayProfit === 0) && Array.isArray(raw?.cumulativePnL) && raw.cumulativePnL.length){
        const last = raw.cumulativePnL[raw.cumulativePnL.length - 1];
        if (last && (last.value!=null)) todayProfit = Number(last.value);
      }
      return {
        todayProfit: isNaN(todayProfit) ? 0 : todayProfit,
        tradesToday: isNaN(tradesToday) ? 0 : tradesToday
      };
    }

    // ====== ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè‡ªå‹•æ¤œå‡ºï¼ˆè¡¨ç¤ºã¯ã—ãªã„ï¼‰ ======
    let METRICS_URL = null;
    async function detectEndpoint(){
      for (const url of TRY_ENDPOINTS){
        try { const r = await fetch(url, {cache:'no-store'}); if (r.ok){ METRICS_URL = url; break; } } catch {}
      }
      if (!METRICS_URL) METRICS_URL = TRY_ENDPOINTS[0];
    }

    // ====== Chart.js ======
    const ctx = document.getElementById('profitChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'ä»Šæ—¥ã®åˆ©ç›Š (ç´¯è¨ˆ)', data: [], tension: 0.25, fill: false, pointRadius: 0, borderWidth: 2 }] },
      options: {
        responsive: true, animation: false,
        scales: {
          x: { title: { display: true, text: 'æ™‚åˆ»' } },
          y: { title: { display: true, text: 'é‡‘é¡ (å††)' }, beginAtZero: true }
        },
        plugins: { legend: { display: true } }
      }
    });
    function pushPoint(label, y){
      const { labels, datasets } = chart.data;
      labels.push(label); datasets[0].data.push(y);
      if (labels.length > MAX_POINTS){ labels.shift(); datasets[0].data.shift(); }
      chart.update();
    }
    function clearChart(){ chart.data.labels.length = 0; chart.data.datasets[0].data.length = 0; chart.update(); }

    // ====== ãƒãƒ¼ãƒªãƒ³ã‚° ======
    let paused = false, timer = null;
    async function pollOnce(){
      if (!METRICS_URL) return;
      try{
        const res = await fetch(METRICS_URL, {cache:'no-store'});
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const raw = await res.json();
        const m = normalizeMetrics(raw);

        document.getElementById('todayProfitValue').textContent  = fmtYen.format(m.todayProfit);
        document.getElementById('tradesTodayValue').textContent = fmtNum.format(m.tradesToday);
        pushPoint(hhmmss(), m.todayProfit);
      }catch(e){
        // è¡¨ç¤ºã¯ãã®ã¾ã¾ï¼ˆã‚¨ãƒ©ãƒ¼ã¯å‡ºã•ãªã„ï¼‰
      }
    }
    function startPolling(){ if (timer) clearInterval(timer); timer = setInterval(() => { if (!paused) pollOnce(); }, POLL_MS); }

    // ====== ã‚¤ãƒ™ãƒ³ãƒˆ ======
    document.getElementById('btnPause').addEventListener('click', () => {
      paused = !paused;
      document.getElementById('btnPause').textContent = paused ? 'â–¶ å†é–‹' : 'â¸ ä¸€æ™‚åœæ­¢';
    });
    document.getElementById('btnClear').addEventListener('click', () => clearChart());

    // ====== åˆæœŸåŒ– ======
    (async function init(){
      await detectEndpoint();
      await pollOnce();
      startPolling();
    })();
  </script>
</body>
</html>
