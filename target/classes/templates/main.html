<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>取引中</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" th:href="@{/css/simple.css}" href="/css/simple.css"/>
  <style>
    .shell{ width:min(1024px,96vw); margin:24px auto }
    .grid4{ display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:14px }
    .tile{
      display:block; background:#fff; border:1px solid #e5e7eb; border-radius:14px;
      box-shadow: 0 6px 16px rgba(2,6,23,.08); text-decoration:none; color:inherit;
      padding:18px; min-height:120px; transition: transform .04s ease, box-shadow .15s ease, border-color .15s ease;
      font-family: inherit;
    }
    .tile:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(2,6,23,.10); border-color:#d9dde6 }
    .tile h3{ margin:0 0 8px; font-size:16px; color:#334155 }
    .tile .sub{ font-size:12px; color:#64748b }
    .value{ font-size:26px; font-weight:800; line-height:1.2; margin-top:6px }
    /* ハイフンは出さない（空の時は空表示） */
    #profit:empty::before, #prices:empty::before { content: ""; }
    /* 終了ボタンカード */
    .end-wrap{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow: 0 6px 16px rgba(2,6,23,.08); padding:18px; }
    .btn-end{
      display:flex; align-items:center; justify-content:center; width:100%; min-height:84px;
      border-radius:12px; border:1px solid #ef4444; background:#ef4444; color:#fff;
      font-weight:800; font-family: inherit; cursor:pointer; transition: transform .04s ease, filter .15s ease;
    }
    .btn-end:hover{ filter:brightness(1.04); transform: translateY(-1px) }
    @media (max-width:720px){ .grid4{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <main class="shell">
    <h1 class="m-0">取引中</h1>

    <div class="grid4" style="margin-top:16px">
      <!-- 1) 銘柄を選ぶ -->
      <a class="tile" href="/ui/select-asset">
        <h3>銘柄を選ぶ</h3>
        <div class="sub">保有や観察したい銘柄を選択</div>
      </a>

      <!-- 2) 今日の利益（ハイフン無し） -->
      <a class="tile" href="/ui/profit-graph">
        <h3>今日の利益</h3>
        <div id="profit" class="value"></div>
      </a>

      <!-- 3) 現在の株価（ハイフン無し） -->
      <a class="tile" href="/ui/matrix">
        <h3>現在の株価</h3>
        <div id="prices" class="value"></div>
      </a>

      <!-- 4) 取引終了（JSでAPIにPOST→必ず /ui に戻す） -->
      <div class="end-wrap">
        <form id="endForm" action="/api/control/trading" method="post" style="margin:0">
          <input type="hidden" name="enabled" value="false"/>
          <button type="submit" class="btn-end">取引終了</button>
        </form>
      </div>
    </div>
  </main>

  <!-- 最小パッチ：送信をフックしてAPIにPOST→成功/失敗に関わらず /ui に戻す -->
  <script>
  (function(){
    var f = document.getElementById('endForm');
    if(!f) return;

    f.addEventListener('submit', function(e){
      e.preventDefault();
      var url = f.action + (f.action.indexOf('?') >= 0 ? '&' : '?') + 'enabled=false';

      // /api を試し、ダメなら /control にフォールバック。いずれにせよ最後は /ui へ戻す
      fetch(url, { method: 'POST', credentials: 'same-origin' })
        .catch(function(){ return fetch('/control/trading?enabled=false', { method: 'POST', credentials: 'same-origin' }); })
        .finally(function(){ window.location.href = '/ui'; });
    });
  })();
  </script>
</body>
</html>
